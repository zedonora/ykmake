# Day 15 - 작업 1: Supabase Storage 설정\n\n애플리케이션에서 사용할 파일(예: 사용자 아바타, 제품/팀 로고)을 저장하기 위해 Supabase Storage를 설정합니다. 여기에는 필요한 버킷(Bucket)을 생성하고, 각 버킷에 대한 접근 제어 정책(Policies)을 정의하는 작업이 포함됩니다.\n\n## 목표\n\n*   사용자 프로필 아바타 이미지를 저장할 `avatars` 버킷을 생성합니다.\n*   제품 또는 팀 로고 이미지를 저장할 `logos` 버킷을 생성합니다. (필요에 따라 `product-logos`, `team-logos` 등으로 구체화 가능)\n*   각 버킷을 공개(Public) 또는 비공개(Private)로 적절히 설정합니다. (일반적으로 아바타와 로고는 공개 버킷 사용)\n*   각 버킷에 대한 스토리지 접근 정책(RLS for Storage)을 설정하여 파일 업로드, 다운로드, 수정, 삭제 권한을 제어합니다.\n\n## 작업 단계\n\n### 1. Supabase 대시보드 이동\n\n1.  Supabase 프로젝트 대시보드로 이동합니다.\n2.  왼쪽 메뉴에서 **Storage** 아이콘을 클릭합니다.\n\n### 2. `avatars` 버킷 생성 및 설정\n\n1.  Storage 페이지에서 **\"New Bucket\"** 버튼을 클릭합니다.\n2.  **Bucket name**: `avatars` 입력 (소문자, 숫자, 하이픈만 사용 가능)\n3.  **Public bucket**: **체크** (아바타는 일반적으로 URL로 직접 접근 가능해야 하므로 공개로 설정)\n4.  (선택 사항) **Allowed MIME types**: `image/jpeg`, `image/png`, `image/gif`, `image/webp` 등 허용할 이미지 타입 지정 가능.\n5.  (선택 사항) **Max file size**: 업로드 가능한 최대 파일 크기 지정 가능 (예: `5MB`).\n6.  **\"Create Bucket\"** 버튼 클릭.\n\n### 3. `logos` 버킷 생성 및 설정\n\n1.  **\"New Bucket\"** 버튼 다시 클릭.\n2.  **Bucket name**: `logos` 입력 (또는 `product-logos`, `team-logos` 등 필요에 따라 구체화)\n3.  **Public bucket**: **체크** (로고도 일반적으로 공개 URL 필요)\n4.  (선택 사항) **Allowed MIME types**: 이미지 타입 지정.\n5.  (선택 사항) **Max file size**: 파일 크기 지정.\n6.  **\"Create Bucket\"** 버튼 클릭.\n\n### 4. `avatars` 버킷 정책(Policies) 설정\n\n1.  Storage 페이지에서 생성된 `avatars` 버킷 옆의 **\"Policies\"** 버튼 (또는 버킷 클릭 후 Policies 탭)을 클릭합니다.\n2.  기본적으로 공개 버킷에는 모든 사용자가 파일을 읽을 수 있는 정책(`SELECT` 권한)이 있을 수 있습니다. 없다면 추가합니다.\n    *   **Policy Name**: `Public Read Access for Avatars`\n    *   **Allowed operation(s)**: `SELECT` 체크\n    *   **Target roles**: `anon`, `authenticated` 선택\n    *   **Policy definition (USING expression)**:\n        ```sql\n        -- 모든 파일에 대한 읽기 허용\n        true\n        ```\n3.  로그인한 사용자가 **자신의 폴더에만** 아바타를 업로드(`INSERT`)할 수 있는 정책을 추가합니다. (파일 경로는 `userId/파일명` 형태를 사용한다고 가정)\n    *   **Policy Name**: `Allow Authenticated Insert for Own Avatar`\n    *   **Allowed operation(s)**: `INSERT` 체크\n    *   **Target roles**: `authenticated` 선택\n    *   **Policy definition (WITH CHECK expression)**:\n        ```sql\n        -- 로그인한 사용자의 ID로 시작하는 경로에만 업로드 허용\n        bucket_id = \'avatars\' AND auth.uid()::text = (storage.foldername(name))[1]\n        -- 또는 파일 경로가 auth.uid()로 시작하는지 확인 (PostgreSQL 함수 사용)\n        -- bucket_id = \'avatars\' AND substr(name, 1, length(auth.uid()::text)) = auth.uid()::text AND strpos(name, \'/\') > 0\n        ```\n        *참고: 위 SQL 정책은 파일 경로의 첫 번째 폴더 이름이 사용자 ID와 일치하는지 확인합니다. Supabase의 `storage.foldername()` 함수나 문자열 함수를 활용합니다. Supabase UI에서 제공하는 템플릿을 활용할 수도 있습니다.*\n4.  로그인한 사용자가 **자신의 폴더에 있는** 아바타를 수정(`UPDATE`) 또는 삭제(`DELETE`)할 수 있는 정책을 추가합니다. (INSERT와 유사한 조건 사용)\n    *   **Policy Name**: `Allow Authenticated Update/Delete for Own Avatar`\n    *   **Allowed operation(s)**: `UPDATE`, `DELETE` 체크\n    *   **Target roles**: `authenticated` 선택\n    *   **Policy definition (USING expression)**:\n        ```sql\n        -- 로그인한 사용자의 ID로 시작하는 경로의 파일만 수정/삭제 허용\n        bucket_id = \'avatars\' AND auth.uid()::text = (storage.foldername(name))[1]\n        ```\n\n### 5. `logos` 버킷 정책(Policies) 설정\n\n1.  `logos` 버킷에 대한 정책을 설정합니다. `avatars`와 유사하지만, 업로드/수정/삭제 권한은 애플리케이션 요구사항에 따라 달라질 수 있습니다.\n2.  **Public Read Access**: `avatars`와 동일하게 모든 사용자가 로고 파일을 읽을 수 있도록 `SELECT` 정책을 설정합니다.\n3.  **Insert/Update/Delete Policies**:\n    *   **시나리오 1: 인증된 사용자 누구나 업로드 가능**:\n        *   Target roles: `authenticated`\n        *   Policy definition: `bucket_id = \'logos\'` (특별한 경로 제한 없음)\n    *   **시나리오 2: 특정 역할(예: 'admin', 'editor')만 업로드 가능**:\n        *   Target roles: `authenticated`\n        *   Policy definition: `bucket_id = \'logos\' AND check_role_permission(auth.uid(), \'upload_logos\')` (별도의 권한 확인 함수 `check_role_permission` 필요)\n    *   **시나리오 3: 제품/팀 소유자만 해당 로고 수정/삭제 가능**:\n        *   `UPDATE`/`DELETE` 정책에서 파일 경로 또는 메타데이터를 사용하여 소유권을 확인하는 로직이 필요합니다. (예: 파일 경로가 `productId/logo.png` 이고, 해당 `productId`의 소유자가 `auth.uid()`인지 확인) - 이는 복잡할 수 있으며, 애플리케이션 로직에서 처리하는 것이 더 간단할 수 있습니다.\n    *   요구사항에 맞는 정책을 정의하고 추가합니다.\n\n## 예상 결과\n\n*   Supabase Storage에 `avatars` 와 `logos` 두 개의 공개 버킷이 생성됩니다.\n*   `avatars` 버킷에는 모든 사용자가 읽을 수 있고, 로그인한 사용자는 자신의 ID로 시작하는 경로에만 파일을 업로드/수정/삭제할 수 있는 정책이 적용됩니다.\n*   `logos` 버킷에는 모든 사용자가 읽을 수 있고, 애플리케이션 요구사항에 따라 정의된 업로드/수정/삭제 정책이 적용됩니다.\n\n## 체크리스트\n\n*   [ ] Supabase 대시보드에서 `avatars` 버킷이 생성되었는가?\n*   [ ] `avatars` 버킷이 \'Public\'으로 설정되었는가?\n*   [ ] `avatars` 버킷에 대한 4가지 정책 (Public Select, Authenticated Insert(own), Authenticated Update(own), Authenticated Delete(own))이 올바르게 설정되었는가?\n*   [ ] Supabase 대시보드에서 `logos` 버킷이 생성되었는가?\n*   [ ] `logos` 버킷이 \'Public\'으로 설정되었는가?\n*   [ ] `logos` 버킷에 대한 정책 (Public Select, 기타 Insert/Update/Delete)이 요구사항에 맞게 설정되었는가?\n``` 