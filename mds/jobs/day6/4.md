# 작업 4: DB 기반 동적 메뉴 구현

## 단계

1.  **메뉴 관련 DB 스키마 정의 (필요시):**
    *   메뉴 항목(`menus`), 사용자 역할(`roles`), 역할별 메뉴 접근 권한(`role_menu_permissions`)을 저장할 테이블을 설계하고 생성합니다. 기존 테이블 구조를 활용하거나 새로 생성합니다. RLS 정책을 적용하여 역할에 따라 접근 가능한 메뉴 데이터만 조회되도록 설정하는 것을 고려합니다.

    !!!sql
    -- 예시: menus 테이블
    CREATE TABLE menus (
      id SERIAL PRIMARY KEY,
      name TEXT NOT NULL,
      path TEXT NOT NULL UNIQUE,
      icon TEXT, -- 메뉴 아이콘 (선택 사항)
      parent_id INTEGER REFERENCES menus(id) ON DELETE CASCADE, -- 하위 메뉴 구현 시
      display_order INTEGER DEFAULT 0
    );

    -- 예시: roles 테이블 (기존 auth.users 역할 외 별도 역할 필요시)
    -- CREATE TABLE roles ( ... );

    -- 예시: role_menu_permissions 테이블
    CREATE TABLE role_menu_permissions (
      role TEXT NOT NULL, -- 또는 roles 테이블 참조
      menu_id INTEGER NOT NULL REFERENCES menus(id) ON DELETE CASCADE,
      can_view BOOLEAN DEFAULT true,
      PRIMARY KEY (role, menu_id)
    );

    -- RLS 정책 예시 (menus 테이블에 적용)
    ALTER TABLE menus ENABLE ROW LEVEL SECURITY;

    CREATE POLICY "Allow view access based on role" ON menus
    FOR SELECT USING (
      EXISTS (
        SELECT 1
        FROM role_menu_permissions rmp
        -- 현재 사용자의 역할을 가져오는 함수 또는 컬럼 필요 (예: custom_auth.get_my_role())
        WHERE rmp.menu_id = menus.id AND rmp.role = custom_auth.get_my_role() AND rmp.can_view = true
      )
      -- 또는 관리자 등 특정 역할은 모든 메뉴 보기 허용
      -- OR custom_auth.get_my_role() = 'admin'
    );
    !!!

2.  **메뉴 데이터 로더 함수 구현:**
    *   사용자의 역할/권한에 따라 접근 가능한 메뉴 목록을 조회하는 서버 측 로직을 구현합니다. 이 로직은 최상위 레이아웃(`app/root.tsx` 또는 공통 레이아웃 파일의 `loader`)에 포함하는 것이 일반적입니다.

    !!!typescript
    // app/root.tsx 또는 관련 레이아웃 파일
    import { supabaseAdmin } from "~/lib/supabase.server";
    import { getCurrentUserRole } from "~/utils/auth.server"; // 사용자 역할을 가져오는 유틸리티 함수 (가정)

    export const loader = async ({ request }: LoaderFunctionArgs) => {
      const userRole = await getCurrentUserRole(request); // 요청에서 사용자 역할 파악

      // 사용자의 역할에 맞는 메뉴 데이터를 DB에서 조회 (RLS 적용된 경우 간단히 select)
      const { data: menuItems, error } = await supabaseAdmin
        .from("menus") // RLS 정책이 적용된 테이블
        .select("id, name, path, icon")
        .order("display_order"); // RLS가 없다면 여기서 role 기준으로 필터링 필요

      if (error) {
        console.error("Error fetching menu items:", error);
        // 오류 처리...
      }

      // 기존 loader 데이터와 함께 메뉴 데이터 반환
      return Response.json({ env: /*...*/, menuItems: menuItems ?? [] });
    };
    !!!

3.  **Header 컴포넌트 수정:**
    *   `Header` 컴포넌트가 `loader`로부터 메뉴 데이터를 받아 동적으로 메뉴 링크를 렌더링하도록 수정합니다.

    !!!typescript
    // app/components/layout/Header.tsx
    import { Link, useMatches } from "@remix-run/react";
    // SiteLogo 등 기존 import ...

    // 메뉴 아이템 타입 정의 (loader 반환 타입과 일치)
    interface MenuItem {
      id: number;
      name: string;
      path: string;
      icon?: string;
    }

    export function Header() {
      // root loader 데이터를 가져오기 위해 useMatches 사용
      const matches = useMatches();
      const rootData = matches.find((match) => match.id === "root");
      const menuItems = rootData?.data?.menuItems as MenuItem[] | undefined;

      return (
        <header className="sticky top-0 z-50 w-full border-b bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60">
          <div className="container flex h-14 items-center">
            <div className="mr-4 hidden md:flex">
              <SiteLogo />
              <nav className="flex items-center space-x-6 text-sm font-medium">
                {/* 동적으로 메뉴 렌더링 */}
                {menuItems?.map((item) => (
                  <Link
                    key={item.id}
                    to={item.path}
                    className="transition-colors hover:text-foreground/80 text-foreground/60"
                  >
                    {/* 아이콘이 있다면 표시 (lucide-react 등 사용) */}
                    {/* item.icon && <Icon name={item.icon} className="mr-2" /> */}
                    {item.name}
                  </Link>
                ))}
              </nav>
            </div>
            {/* 모바일 메뉴 버튼, 테마 토글 등 기존 요소... */}
            <div className="flex flex-1 items-center justify-end space-x-4">
               <ThemeToggle/>
            </div>
          </div>
        </header>
      );
    }
    !!!

## 완료 확인

*   메뉴 관련 DB 테이블 및 RLS 정책이 올바르게 생성/설정되었는지 확인합니다.
*   `loader` 함수가 사용자의 역할에 따라 적절한 메뉴 데이터를 반환하는지 확인합니다 (로그 또는 디버깅).
*   Header 컴포넌트가 로드된 메뉴 데이터를 기반으로 동적으로 네비게이션 링크를 렌더링하는지 확인합니다.
*   로그인/로그아웃 또는 사용자 역할 변경 시 Header의 메뉴가 올바르게 업데이트되는지 확인합니다. 