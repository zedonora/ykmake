# Day 13 - 개념 1: 관계형 데이터 모델링 (일대다), 외래 키, 제약 조건

`jobs/day13/1.md`에서는 게시글에 대한 댓글(`replies`)과 제품에 대한 리뷰(`reviews`) 테이블을 정의했습니다. 이는 관계형 데이터베이스 모델링의 핵심 개념인 **테이블 간의 관계**, **외래 키(Foreign Key)**, 그리고 데이터 무결성을 위한 **제약 조건(Constraints)**을 활용하는 좋은 예시입니다.

## 1. 테이블 간의 관계 (Relationships)

관계형 데이터베이스는 데이터를 여러 테이블에 나누어 저장하고, 테이블 간의 논리적인 관계를 정의하여 정보를 연결합니다. 이를 통해 데이터 중복을 최소화하고 일관성을 유지할 수 있습니다.

*   **일대다 관계 (One-to-Many Relationship)**: 가장 흔한 관계 유형 중 하나입니다. 한 테이블의 레코드 하나가 다른 테이블의 여러 레코드와 연결될 수 있는 관계입니다.
    *   **게시글과 댓글 (`posts` <-> `replies`)**: 하나의 게시글(`posts` 테이블의 행 하나)에는 여러 개의 댓글(`replies` 테이블의 행 여러 개)이 달릴 수 있습니다. 하지만 각 댓글은 오직 하나의 게시글에만 속합니다.
    *   **제품과 리뷰 (`products` <-> `reviews`)**: 하나의 제품(`products` 테이블의 행 하나)에는 여러 개의 리뷰(`reviews` 테이블의 행 여러 개)가 작성될 수 있습니다. 각 리뷰는 특정 제품 하나에 대한 것입니다.
*   **일대일 관계 (One-to-One Relationship)**: 한 테이블의 레코드 하나가 다른 테이블의 레코드 하나와만 연결되는 관계입니다. (예: 사용자 테이블과 사용자 프로필 상세 테이블)
*   **다대다 관계 (Many-to-Many Relationship)**: 한 테이블의 여러 레코드가 다른 테이블의 여러 레코드와 연결될 수 있는 관계입니다. 이는 보통 중간에 **조인 테이블(Join Table)** 또는 **연결 테이블(Linking Table)**을 두어 두 개의 일대다 관계로 구현됩니다. (예: 학생과 강의 - 학생은 여러 강의를 듣고, 강의는 여러 학생이 들음. 중간에 '수강신청' 테이블 필요)

## 2. 외래 키 (Foreign Key - FK)

*   **목적**: 테이블 간의 관계를 실제로 데이터베이스에 구현하는 메커니즘입니다. 한 테이블(자식 테이블)의 컬럼이 다른 테이블(부모 테이블)의 기본 키(Primary Key)를 참조하도록 하여 두 테이블을 연결합니다.
*   **역할**:
    *   **관계 설정**: 어떤 댓글이 어떤 게시글에 속하는지, 어떤 리뷰가 어떤 제품에 대한 것인지 명확히 나타냅니다.
    *   **참조 무결성(Referential Integrity) 강제**: 외래 키 제약 조건은 자식 테이블의 외래 키 컬럼 값이 반드시 부모 테이블의 기본 키 값 중 하나이거나 `NULL`이어야 함을 보장합니다. 이를 통해 존재하지 않는 게시글에 댓글이 달리거나, 존재하지 않는 제품에 리뷰가 작성되는 것을 방지합니다.
*   **구현**: `REFERENCES` 키워드를 사용하여 정의합니다.
    ```sql
    -- replies 테이블의 post_id 컬럼은 posts 테이블의 id 컬럼을 참조함
    post_id uuid NOT NULL REFERENCES public.posts(id)

    -- reviews 테이블의 product_id 컬럼은 products 테이블의 id 컬럼을 참조함
    product_id uuid NOT NULL REFERENCES public.products(id)
    ```
*   **`ON DELETE` 옵션**: 참조하고 있는 부모 테이블의 행이 **삭제될 때** 자식 테이블의 관련 행을 어떻게 처리할지 지정하는 중요한 옵션입니다.
    *   **`CASCADE`**: 부모 행이 삭제되면, 해당 행을 참조하는 자식 테이블의 모든 행도 **함께 자동으로 삭제**됩니다.
        *   예: `post_id ... ON DELETE CASCADE` - 게시글이 삭제되면 해당 게시글의 모든 댓글도 자동으로 삭제됩니다. (일반적으로 댓글에 적합)
        *   예: `product_id ... ON DELETE CASCADE` - 제품이 삭제되면 해당 제품의 모든 리뷰도 자동으로 삭제됩니다. (일반적으로 리뷰에 적합)
    *   **`SET NULL`**: 부모 행이 삭제되면, 해당 행을 참조하는 자식 테이블의 외래 키 컬럼 값이 `NULL`로 설정됩니다. (단, 해당 외래 키 컬럼이 `NULL`을 허용해야 합니다.)
        *   예: `user_id ... ON DELETE SET NULL` - 사용자가 탈퇴(삭제)하더라도 그 사용자가 작성했던 댓글이나 리뷰 자체는 남겨두고 싶을 때 사용합니다. `user_id`만 `NULL`이 됩니다.
    *   **`RESTRICT` 또는 `NO ACTION`**: 자식 테이블에 해당 부모 행을 참조하는 행이 하나라도 존재하면 부모 행의 삭제를 **허용하지 않습니다.** (오류 발생)
        *   예: 중요한 데이터가 연결되어 있어 부모 데이터가 함부로 삭제되는 것을 막고 싶을 때 사용합니다.
    *   **`SET DEFAULT`**: 부모 행이 삭제되면 자식 테이블의 외래 키 컬럼 값이 미리 지정된 기본값(Default Value)으로 설정됩니다. (컬럼에 기본값 설정 필요)
    *   **선택**: 어떤 옵션을 선택할지는 애플리케이션의 데이터 정책과 요구사항에 따라 신중하게 결정해야 합니다. `CASCADE`는 편리하지만 실수로 중요한 데이터를 연쇄적으로 삭제할 위험이 있고, `SET NULL`은 관계는 끊어지지만 데이터는 보존하며, `RESTRICT`는 데이터 무결성을 가장 엄격하게 유지합니다.

## 3. 제약 조건 (Constraints)

*   **목적**: 테이블에 저장되는 데이터의 규칙을 정의하여 데이터의 정확성, 일관성, 무결성을 보장하는 기능입니다.
*   **종류**:
    *   **`NOT NULL`**: 해당 컬럼에 `NULL` 값을 허용하지 않습니다. 필수적인 정보(예: 댓글 내용, 리뷰 별점, 외래 키 등)에 적용됩니다.
    *   **`UNIQUE`**: 해당 컬럼(또는 컬럼 조합)의 모든 값이 테이블 내에서 고유해야 합니다. (예: 사용자 이메일)
    *   **`PRIMARY KEY (PK)`**: `NOT NULL`과 `UNIQUE` 제약 조건이 결합된 것으로, 테이블의 각 행을 고유하게 식별합니다. (예: `id` 컬럼)
    *   **`FOREIGN KEY (FK)`**: 다른 테이블의 `PRIMARY KEY`를 참조하여 관계를 설정하고 참조 무결성을 보장합니다.
    *   **`CHECK`**: 컬럼에 저장될 수 있는 값의 조건을 지정합니다. 조건을 만족하지 않는 데이터는 삽입(INSERT) 또는 수정(UPDATE)할 수 없습니다.
        *   예: `reviews` 테이블의 `rating` 컬럼에 `CHECK (rating >= 1 AND rating <= 5)` 제약 조건을 추가하면, 1에서 5 사이의 정수만 입력 가능하도록 강제하여 잘못된 별점 데이터가 들어오는 것을 막을 수 있습니다.

## 요약

댓글이나 리뷰와 같이 다른 데이터(게시글, 제품)와 관계를 맺는 데이터를 모델링할 때는 **일대다 관계**를 이해하고 **외래 키(Foreign Key)**를 사용하여 테이블을 연결하는 것이 중요합니다. 외래 키의 **`ON DELETE` 옵션**은 참조하는 데이터가 삭제될 때 관련 데이터를 어떻게 처리할지 결정하는 핵심 설정입니다. 또한, `NOT NULL`, `UNIQUE`, `CHECK`와 같은 **제약 조건**을 적절히 활용하면 데이터베이스 수준에서 데이터의 무결성을 효과적으로 관리할 수 있습니다. 