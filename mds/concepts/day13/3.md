# Day 13 - 개념 3: 리뷰 시스템 구현 고려사항 (별점, 평균, 제약)

`jobs/day13/3.md`에서는 제품 리뷰 기능을 구현합니다. 댓글 기능과 유사하지만, 리뷰 시스템은 **별점(Rating)**이라는 정량적 평가 요소가 추가되고, **평균 점수 계산** 및 **중복 작성 방지**와 같은 추가적인 고려사항이 있습니다.

## 1. 별점(Rating) 처리

*   **UI 구현**: 사용자에게 직관적으로 별점을 선택하게 하는 것이 중요합니다.
    *   **시각적 요소**: 별 아이콘(`★`, ☆)을 사용하는 것이 일반적입니다. 5개의 별을 표시하고 사용자가 클릭하거나 마우스 오버하는 별까지 채워진 상태로 보여주는 인터랙션을 구현할 수 있습니다.
    *   **입력 방식**:\
        *   **Radio Group**: 각 별점(1~5)에 해당하는 라디오 버튼을 만들고 스타일링하여 별처럼 보이게 할 수 있습니다. `jobs/day13/3.md` 예시처럼 Shadcn UI의 `RadioGroup`을 활용할 수 있습니다.\
        *   **Custom Component**: JavaScript로 별 클릭 이벤트를 처리하고 숨겨진 `input` 필드에 값을 설정하는 커스텀 컴포넌트를 만들 수 있습니다. 더 정교한 UI/UX 구현이 가능합니다.\
        *   **라이브러리 활용**: React에는 별점 입력을 위한 다양한 라이브러리(`react-stars`, `react-rating-stars-component` 등)가 존재하지만, Shadcn UI와의 통합이나 번들 크기를 고려해야 합니다.\
*   **데이터 처리**:\
    *   **유효성 검사**: `action` 함수에서 Zod 등을 사용하여 별점이 반드시 1~5 사이의 정수인지 검증해야 합니다. `z.coerce.number()`를 사용하면 폼에서 문자열로 전달된 값을 숫자로 변환한 후 검사할 수 있습니다.\
    *   **데이터베이스**: `reviews` 테이블의 `rating` 컬럼은 `smallint` 또는 `integer` 타입으로 정의하고, `CHECK (rating >= 1 AND rating <= 5)` 제약 조건을 설정하여 데이터베이스 수준에서도 유효한 값만 저장되도록 하는 것이 좋습니다. (`jobs/day13/1.md`에서 이미 정의됨)\

## 2. 평균 별점 계산 및 표시

제품 목록이나 상세 페이지에서 평균 별점을 보여주는 것은 사용자에게 유용한 정보입니다.

*   **계산 시점 및 방법**:\
    *   **Loader 함수에서 계산**: `loader` 함수 내에서 해당 제품의 모든 리뷰를 가져온 후, JavaScript 코드로 평균을 계산하여 UI 컴포넌트로 전달합니다. (`jobs/day13/3.md` 예시)\
        *   **장점**: 구현이 비교적 간단합니다.\
        *   **단점**: 리뷰 수가 매우 많아지면 모든 리뷰 데이터를 가져와 클라이언트 또는 서버(loader 실행 환경)에서 계산하는 것이 비효율적일 수 있습니다.\
    *   **데이터베이스 쿼리/함수 활용**:\
        *   **Supabase View**: 리뷰 데이터와 평균 별점을 함께 제공하는 데이터베이스 뷰(View)를 생성할 수 있습니다. `loader`에서는 이 뷰를 조회합니다.\
        *   **Supabase RPC (Remote Procedure Call)**: 특정 `productId`를 인자로 받아 평균 별점을 계산하여 반환하는 데이터베이스 함수(Stored Procedure)를 만들고, `loader`에서 `supabase.rpc('calculate_average_rating', { product_id: productId })` 와 같이 호출할 수 있습니다.\
        *   **장점**: 데이터베이스 엔진이 최적화된 방식으로 계산을 수행하므로 성능상 이점이 있습니다. 특히 리뷰 수가 많을 때 효율적입니다.\
        *   **단점**: 데이터베이스 스키마나 함수를 추가로 관리해야 합니다.\
*   **표시**: 계산된 평균 별점을 별 아이콘과 숫자(예: 4.5)로 함께 표시하여 시각적인 이해를 돕습니다. 총 리뷰 개수도 함께 보여주는 것이 일반적입니다.\

## 3. 추가 고려사항

*   **리뷰 수정 및 삭제**: 사용자가 자신이 작성한 리뷰를 수정하거나 삭제할 수 있는 기능을 제공할 수 있습니다.\
    *   댓글 수정/삭제와 유사하게, 리뷰 목록에서 자신의 리뷰 옆에만 \'수정\', \'삭제\' 버튼을 표시합니다.\
    *   삭제는 별도의 `action` (또는 동일 `action` 내에서 `intent` 값으로 구분)으로 처리하고, RLS 정책(`DELETE` 권한)을 통해 본인만 삭제 가능하도록 합니다.\
    *   수정은 별도의 수정 페이지(`/products/:productId/reviews/:reviewId/edit`)로 이동하거나, 인라인(Inline) 편집 형태로 구현할 수 있습니다. 마찬가지로 `action`과 RLS 정책(`UPDATE` 권한)이 필요합니다.\
*   **중복 리뷰 방지**: 일반적으로 한 사용자는 특정 제품에 대해 하나의 리뷰만 작성하도록 제한합니다.\
    *   **데이터베이스 제약 조건**: `reviews` 테이블에 `(user_id, product_id)` 조합에 대해 `UNIQUE` 제약 조건을 추가하는 것이 가장 확실한 방법입니다. 이렇게 하면 데이터베이스 수준에서 중복 삽입이 자동으로 방지됩니다.\
        ```sql\
        ALTER TABLE public.reviews\
        ADD CONSTRAINT reviews_user_id_product_id_key UNIQUE (user_id, product_id);\
        ```\
    *   **Action 함수 로직**: `action` 함수 내에서 리뷰를 `insert` 하기 전에 해당 사용자가 이미 해당 제품에 리뷰를 작성했는지 확인하는 로직을 추가할 수도 있습니다. 하지만 동시성 문제 등이 발생할 수 있으므로 DB 제약 조건이 더 선호됩니다.\
    *   **UI 처리**: 사용자가 이미 리뷰를 작성했다면 리뷰 작성 폼을 비활성화하거나 \'리뷰 수정\' 버튼을 대신 보여주는 방식으로 UI를 처리합니다. `loader`에서 현재 사용자의 리뷰 존재 여부를 확인하여 이 정보를 UI 컴포넌트로 전달할 수 있습니다.\
*   **리뷰 정렬 및 필터링**: 리뷰 목록을 최신순, 최고 평점순, 최저 평점순 등으로 정렬하거나 특정 별점의 리뷰만 필터링하는 기능을 제공하여 사용 편의성을 높일 수 있습니다. 이는 `loader` 함수의 Supabase 쿼리(`order()`, `gte()`, `lte()` 등)를 동적으로 변경하여 구현할 수 있습니다.\

## 요약

제품 리뷰 시스템은 댓글 시스템에 더해 별점 처리, 평균 별점 계산, 중복 작성 방지 등의 고려사항이 추가됩니다. 별점 UI는 사용자 친화적으로 구현하고, 데이터 유효성 검사는 클라이언트, 서버(action), 데이터베이스(CHECK 제약) 다방면에서 수행하는 것이 좋습니다. 평균 별점은 `loader`에서 계산하거나 성능을 위해 DB 함수/뷰를 활용할 수 있습니다. 사용자 편의를 위해 리뷰 수정/삭제 기능을 제공하고, 데이터 무결성을 위해 `UNIQUE` 제약 조건으로 중복 리뷰를 방지하는 것이 중요합니다. 