# Day 26: RLS 정책 심층 검토 및 강화 전략

## 개념

단순히 RLS를 활성화하는 것을 넘어, 애플리케이션의 보안 요구사항을 충족시키기 위해 **RLS 정책을 체계적으로 검토하고 지속적으로 강화**하는 것은 매우 중요합니다. 이는 데이터 유출, 비인가 접근, 데이터 변조 등의 보안 위협으로부터 애플리케이션과 사용자 데이터를 보호하는 핵심적인 과정입니다.

RLS 정책 검토 및 강화는 다음과 같은 목표를 가집니다.

-   **정확성:** 정의된 정책이 의도한 대로 정확하게 작동하는지 확인합니다.
-   **완전성:** 필요한 모든 테이블과 작업(SELECT, INSERT, UPDATE, DELETE)에 대해 적절한 정책이 누락 없이 설정되었는지 확인합니다.
-   **최소 권한 원칙 준수:** 사용자에게 꼭 필요한 최소한의 데이터 접근 권한만을 부여하여 불필요한 노출을 최소화합니다.
-   **유지보수성:** 정책이 이해하기 쉽고, 애플리케이션 변경에 따라 수정 및 관리가 용이하도록 작성합니다.

## 핵심 원리 및 전략

효과적인 RLS 정책 검토 및 강화를 위한 주요 원리와 전략은 다음과 같습니다.

1.  **체계적인 접근 시나리오 정의:**
    -   단순히 "자신의 것만 접근"을 넘어, 다양한 사용자 역할(예: 관리자, 편집자, 일반 사용자, 익명 사용자)과 각 역할이 수행할 수 있는 구체적인 작업(CRUD)을 테이블별로 명확하게 문서화합니다. 이는 정책 설계의 기준점이 됩니다.

2.  **기본 거부 (Default Deny) 원칙:**
    -   RLS를 활성화하면 기본적으로 모든 접근이 차단됩니다. 이 원칙을 유지하며, 명시적으로 허용해야 하는 접근에 대해서만 `PERMISSIVE` 정책을 추가합니다. 이는 실수로 인한 데이터 노출을 방지하는 데 도움이 됩니다.

3.  **`USING`과 `WITH CHECK`의 명확한 구분 및 활용:**
    -   `USING (condition)`: 어떤 행이 **보이거나 대상이 될 수 있는지**를 결정합니다. 주로 `SELECT`, `UPDATE`, `DELETE`에 사용됩니다.
    -   `WITH CHECK (condition)`: 어떤 행이 **삽입되거나 수정될 수 있는지**를 결정합니다. 주로 `INSERT`, `UPDATE`에 사용되며, 데이터 무결성을 강제하는 데 중요합니다.
    -   `UPDATE`의 경우, `USING`과 `WITH CHECK` 조건을 모두 사용하여 "특정 행을 수정할 수 있는 권한이 있고(USING), 수정된 결과도 여전히 특정 조건을 만족해야 한다(WITH CHECK)"는 규칙을 만들 수 있습니다.

4.  **역할 기반 접근 제어 (RBAC) 통합:**
    -   단순히 `auth.uid()` 비교를 넘어, 사용자 역할을 정의하고 이를 RLS 정책에 활용합니다. Supabase에서는 사용자의 `app_metadata`에 역할을 저장하고, RLS 정책에서 `auth.jwt() ->> 'app_metadata' ->> 'role'` 과 같은 방식으로 JWT 클레임을 확인하여 역할 기반 정책을 구현할 수 있습니다. (역할 관리를 위한 별도 로직 필요)

5.  **보안 함수 (Security Definer Functions) 활용:**
    -   복잡하거나 반복적인 권한 검증 로직은 PostgreSQL 함수로 캡슐화하고, `SECURITY DEFINER` 옵션을 사용하여 해당 함수가 함수 생성자(일반적으로 높은 권한)의 권한으로 실행되도록 할 수 있습니다. 이를 통해 정책 자체는 단순하게 유지하면서 안전하게 복잡한 검증을 수행할 수 있습니다. 단, `SECURITY DEFINER` 함수는 보안상 신중하게 작성하고 사용해야 합니다.

6.  **성능 고려:**
    -   RLS 정책 내의 조건문(특히 함수 호출이나 복잡한 하위 쿼리)은 쿼리 성능에 영향을 줄 수 있습니다. `EXPLAIN ANALYZE`를 사용하여 쿼리 실행 계획을 분석하고, 필요한 경우 정책 조건을 최적화하거나 관련 컬럼에 인덱스를 생성하는 것을 고려합니다.

7.  **정기적인 검토 및 테스트:**
    -   애플리케이션 기능이 변경되거나 새로운 사용자 역할이 추가될 때마다 관련 RLS 정책을 검토하고 업데이트해야 합니다.
    -   자동화된 테스트 또는 수동 테스트를 통해 정책이 다양한 시나리오와 엣지 케이스에서 올바르게 작동하는지 정기적으로 검증합니다.

## 애플리케이션 코드와의 관계

-   RLS는 데이터베이스 레벨의 보안 장치이지만, 애플리케이션 코드(예: Drizzle 쿼리)에서도 기본적인 유효성 검사나 사용자 경험을 위한 조건부 로직이 필요할 수 있습니다. 예를 들어, RLS 정책에 의해 특정 버튼이 비활성화되어야 하는 경우, 프론트엔드 코드에서 해당 상태를 반영해야 합니다.
-   RLS 정책 위반 시 데이터베이스는 에러를 반환합니다. 애플리케이션 코드에서는 이러한 에러를 적절히 처리하여 사용자에게 의미 있는 피드백을 제공해야 합니다.

철저한 RLS 정책 검토와 강화는 애플리케이션 보안의 근간을 이루며, 데이터베이스 접근을 안전하고 통제된 방식으로 관리하는 데 필수적입니다. 