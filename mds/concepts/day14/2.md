# Day 14 - 개념 2: 프로필 수정과 파일 업로드, 데이터 업데이트 보안

`jobs/day14/2.md`에서는 사용자가 자신의 프로필(사용자 이름, 아바타)을 수정하는 기능을 구현합니다. 이 과정에는 **파일 업로드 처리**, **데이터베이스 업데이트**, **보안**과 관련된 중요한 개념들이 포함됩니다.

## 1. Remix에서의 파일 업로드 처리

HTML 폼에서 파일을 전송하려면 `<form>` 태그에 `encType=\"multipart/form-data\"` 속성을 설정해야 합니다. Remix는 이러한 요청을 처리하기 위한 내장 유틸리티를 제공합니다.

*   **`encType=\"multipart/form-data\"`**: 브라우저가 폼 데이터를 여러 부분(part)으로 나누어 인코딩하도록 지시합니다. 텍스트 데이터와 파일 데이터가 각각 별도의 파트로 전송됩니다.
*   **`unstable_parseMultipartFormData`**: Remix(`@remix-run/node`)에서 제공하는 함수로, `multipart/form-data` 요청을 파싱하는 데 사용됩니다. 이 함수는 업로드된 파일을 어떻게 처리할지 정의하는 **업로드 핸들러(Upload Handler)**를 인자로 받습니다.
*   **업로드 핸들러 (Upload Handler)**: 업로드된 각 파일 스트림을 어떻게 처리할지 정의하는 함수입니다. Remix는 몇 가지 기본 핸들러를 제공합니다.
    *   `unstable_createMemoryUploadHandler`: 파일을 메모리에 버퍼링합니다. 작은 파일에 적합하지만, 서버 메모리 사용량에 주의해야 합니다. 파일 크기 제한(`maxPartSize`) 설정이 가능합니다.
    *   `unstable_createFileUploadHandler`: 파일을 서버의 임시 디렉토리에 저장합니다. 큰 파일 처리에 더 적합합니다. 저장 경로, 파일 이름 생성 방식 등을 설정할 수 있습니다.
    *   **커스텀 핸들러**: 필요하다면 직접 업로드 핸들러를 구현하여 클라우드 스토리지(예: Supabase Storage)로 직접 스트리밍하는 등의 고급 처리를 할 수 있습니다.
*   **데이터 접근**: 파싱된 `formData` 객체에서 `formData.get(\"fieldName\")`을 사용하여 텍스트 데이터와 파일 데이터(업로드 핸들러가 반환한 값, 예: `File` 객체 또는 파일 경로 문자열)에 접근할 수 있습니다.

## 2. Supabase Storage를 이용한 아바타 업로드

사용자 아바타와 같은 파일은 일반적으로 데이터베이스에 직접 저장하지 않고, 별도의 파일 스토리지 서비스에 저장한 후 데이터베이스에는 해당 파일의 URL만 저장합니다. Supabase는 자체적으로 **Supabase Storage**라는 객체 스토리지 서비스를 제공합니다.

*   **버킷(Bucket)**: 파일을 저장하는 컨테이너입니다. 아바타 파일을 저장할 'avatars'와 같은 이름의 버킷을 미리 Supabase 대시보드에서 생성해야 합니다. 버킷은 공개(public) 또는 비공개(private)로 설정할 수 있습니다. 아바타처럼 누구나 볼 수 있어야 하는 파일은 **공개 버킷**으로 설정하는 것이 일반적입니다.
*   **파일 업로드**: `action` 함수 내에서 `supabase.storage.from('버킷이름').upload('파일경로/파일명', 파일객체, { 옵션 })` 메서드를 사용하여 파일을 업로드합니다.
    *   **파일 경로/이름**: 충돌을 피하기 위해 고유한 경로와 이름을 사용하는 것이 좋습니다. 보통 사용자 ID를 포함하는 폴더 경로(`userId/`) 와 타임스탬프 또는 UUID를 결합한 파일명(`avatar-${Date.now()}.png`)을 사용합니다.
    *   **옵션**:
        *   `cacheControl`: 브라우저 캐싱 시간을 설정합니다. (예: `'3600'` = 1시간)
        *   `upsert`: `true`로 설정하면 같은 경로/이름의 파일이 이미 존재할 경우 덮어씁니다. 프로필 사진 업데이트 시 유용합니다.
*   **공개 URL 가져오기**: 파일 업로드 성공 후, `supabase.storage.from('버킷이름').getPublicUrl('파일경로/파일명')` 메서드를 사용하여 해당 파일에 접근할 수 있는 공개 URL을 얻습니다. 이 URL을 `profiles` 테이블의 `avatar_url` 컬럼에 저장합니다.
*   **접근 제어 (Storage RLS)**: Supabase Storage에도 Row Level Security와 유사한 **스토리지 정책(Policy)**을 설정하여 파일 접근 권한(업로드, 다운로드, 수정, 삭제)을 세밀하게 제어할 수 있습니다.
    *   **아바타 버킷 정책 예시**:
        *   모든 사용자가 파일을 읽을 수 있도록 허용 (`SELECT` 권한 부여).
        *   로그인한 사용자만 자신의 폴더(`userId/`)에 파일을 업로드/수정/삭제할 수 있도록 허용 (`INSERT`, `UPDATE`, `DELETE` 권한 부여, 경로에 `auth.uid()` 사용).

## 3. 데이터 업데이트 시 보안 고려사항

사용자 프로필과 같이 민감할 수 있는 데이터를 업데이트할 때는 보안을 철저히 고려해야 합니다.

*   **인가(Authorization)**: **가장 중요합니다.** `action` 함수 시작 부분에서 반드시 현재 로그인된 사용자를 확인하고, **로그인된 사용자 자신의 데이터만 수정**하도록 강제해야 합니다.
    *   `createServerClient`로 얻은 `user` 객체를 확인합니다. (`if (!user) { return 401; }`)
    *   데이터베이스 `UPDATE` 쿼리에 `eq('id', user.id)` 조건을 **반드시** 포함하여 다른 사용자의 레코드가 수정되는 것을 방지합니다. 폼에서 hidden input으로 `userId`를 받아 사용하는 것은 보안상 취약할 수 있습니다 (사용자가 값을 위변조할 수 있음).
*   **입력값 검증(Validation)**: 서버 측(`action` 함수)에서 Zod 등을 사용하여 모든 입력값(사용자 이름, 파일 정보 등)을 철저히 검증합니다. 클라이언트 측 검증은 사용자 경험을 위한 것이며, 보안을 위해서는 서버 측 검증이 필수입니다.
*   **사용자 이름 고유성(Uniqueness)**: 사용자 이름은 보통 고유해야 합니다.
    *   **DB 제약 조건**: `profiles` 테이블의 `username` 컬럼에 `UNIQUE` 제약 조건을 설정하는 것이 가장 확실합니다.
    *   **Action 로직**: `action` 함수에서 DB 업데이트 전에 새로운 사용자 이름이 다른 사용자에 의해 이미 사용 중인지 확인하는 로직을 추가합니다. 이때, 자기 자신의 기존 이름으로 변경하는 경우는 허용해야 하므로, `neq('id', user.id)` 조건을 사용하여 본인을 제외하고 검색합니다.
*   **Supabase RLS**: `profiles` 테이블에 대한 RLS 정책을 설정하여, 사용자가 자신의 레코드만 `UPDATE` 할 수 있도록 제한해야 합니다.
    ```sql
    -- 예시: 로그인한 사용자가 자신의 profiles 레코드만 업데이트 허용
    CREATE POLICY "Allow individual profile update access"
    ON public.profiles FOR UPDATE
    USING (auth.uid() = id); -- 본인 확인
    ```

## 요약

Remix에서 파일 업로드를 처리하려면 `encType=\"multipart/form-data\"` 설정과 `unstable_parseMultipartFormData` 및 업로드 핸들러 사용법을 알아야 합니다. Supabase Storage는 파일 저장에 편리하며, 버킷 생성, 파일 업로드, 공개 URL 얻기, 스토리지 정책 설정이 주요 과정입니다. 프로필 업데이트 시에는 **인가(Authorization)**가 핵심이며, `action` 함수에서 반드시 로그인된 사용자를 확인하고 자신의 데이터만 수정하도록 DB 쿼리 조건을 설정해야 합니다. 입력값 검증과 사용자 이름 고유성 처리, 그리고 Supabase 테이블 및 스토리지 RLS 정책 설정도 중요한 보안 요소입니다. 