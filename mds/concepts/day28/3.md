# Day 28: 데이터베이스 마이그레이션 개념

## 1. 데이터베이스 마이그레이션이란?

데이터베이스 마이그레이션(Database Migration)은 데이터베이스 스키마(Schema)의 변경 사항을 관리하고 적용하는 체계적인 프로세스를 의미합니다. 마치 코드에 버전 관리를 사용하는 것처럼, 데이터베이스 스키마의 변경 이력을 관리하고, 여러 환경(개발, 테스트, 운영)에 걸쳐 스키마를 일관되게 유지하며, 변경 사항을 점진적이고 통제된 방식으로 적용할 수 있게 해줍니다.

마이그레이션은 일반적으로 다음과 같은 스키마 변경 작업을 포함합니다:

-   테이블 생성, 수정, 삭제
-   컬럼 추가, 수정(타입 변경, 제약 조건 변경 등), 삭제
-   인덱스 생성, 삭제
-   관계(Foreign Key) 설정, 변경, 삭제
-   뷰, 저장 프로시저 등 데이터베이스 객체 관리

## 2. 왜 데이터베이스 마이그레이션이 필요한가?

-   **버전 관리:** 데이터베이스 스키마의 변경 이력을 추적하고 관리할 수 있습니다. 특정 시점의 스키마 상태를 알 수 있고, 필요시 이전 버전으로 돌아가는 것(롤백)을 계획할 수 있습니다.
-   **협업 용이성:** 여러 개발자가 동일한 데이터베이스 스키마를 기반으로 작업할 때, 마이그레이션 시스템을 통해 스키마 변경 사항을 공유하고 충돌 없이 적용할 수 있습니다.
-   **환경 간 일관성 유지:** 개발, 테스트, 운영 등 여러 환경에서 동일한 스키마 구조를 유지하여 환경 차이로 인한 예기치 않은 오류를 방지합니다.
-   **안전하고 예측 가능한 변경:** 스키마 변경 작업을 스크립트화하고 자동화함으로써 수동 작업으로 인한 실수를 줄이고, 변경 과정을 예측 가능하게 만듭니다.
-   **배포 자동화:** 마이그레이션 프로세스를 CI/CD 파이프라인에 통합하여 애플리케이션 배포 시 데이터베이스 스키마 변경을 자동으로 적용할 수 있습니다.

## 3. Drizzle ORM과 마이그레이션

Drizzle ORM은 `drizzle-kit`이라는 별도의 CLI 도구를 통해 데이터베이스 마이그레이션 기능을 제공합니다.

-   **선언적 스키마 정의:** 개발자는 TypeScript 코드(`src/db/schema.ts`)로 원하는 데이터베이스 스키마 구조를 선언적으로 정의합니다.
-   **`drizzle-kit`의 역할:**
    -   **스키마 비교:** 현재 데이터베이스 스키마 상태(또는 이전 마이그레이션 상태)와 코드에 정의된 스키마를 비교합니다.
    -   **SQL 마이그레이션 파일 생성:** 비교 결과를 바탕으로, 현재 스키마를 코드에 정의된 스키마 상태로 변경하는 데 필요한 SQL 문을 담은 마이그레이션 파일(`.sql`)을 자동으로 생성합니다.
    -   **상태 스냅샷 관리:** 마이그레이션 적용 상태를 추적하기 위한 메타데이터를 관리합니다 (예: `_meta` 폴더의 `snapshot.json`).
-   **마이그레이션 실행:** 생성된 SQL 마이그레이션 파일은 Drizzle ORM의 마이그레이션 함수 (`drizzle-orm/<driver>/migrator`의 `migrate` 함수)를 사용하여 대상 데이터베이스에 적용됩니다. 이 함수는 아직 적용되지 않은 마이그레이션 파일들을 순서대로 실행합니다.

## 4. 주요 용어

-   **스키마 (Schema):** 데이터베이스의 구조, 즉 테이블, 컬럼, 관계, 제약 조건 등에 대한 정의입니다.
-   **마이그레이션 파일 (Migration File):** 특정 스키마 변경 작업을 수행하는 SQL 문이 포함된 파일입니다. 일반적으로 타임스탬프나 버전 번호로 순서가 관리됩니다. Drizzle Kit은 주로 SQL 파일을 생성합니다.
-   **Up 마이그레이션:** 스키마를 다음 버전으로 변경하는 작업 (예: 테이블 추가, 컬럼 추가). Drizzle Kit이 생성하는 SQL 파일의 주 내용입니다.
-   **Down 마이그레이션 (롤백):** 스키마 변경 사항을 되돌리는 작업 (Up 마이그레이션의 반대). Drizzle Kit은 기본적으로 Down 마이그레이션 SQL을 생성하지 않으므로, 롤백은 주로 데이터베이스 백업 복원이나 수동 SQL 작성을 통해 이루어집니다.

## 5. 마이그레이션 모범 사례

-   **작은 단위로 마이그레이션:** 한 번에 너무 많은 변경을 하기보다는 작고 논리적인 단위로 나누어 마이그레이션을 생성하고 적용합니다.
-   **항상 테스트:** 운영 환경 적용 전에 반드시 스테이징 또는 테스트 환경에서 마이그레이션을 충분히 테스트합니다.
-   **백업 필수:** 중요한 마이그레이션 전에는 반드시 데이터베이스를 백업합니다.
-   **파괴적인 변경 주의:** 테이블 삭제, 컬럼 삭제, 데이터 타입 변경 등 데이터 손실이나 호환성 문제를 일으킬 수 있는 변경은 특히 신중하게 계획하고 테스트해야 합니다. (필요시 확장-축소(expand-contract) 패턴 고려)
-   **생성된 SQL 검토:** 자동 생성된 마이그레이션 SQL이라도 반드시 내용을 확인하고 의도와 맞는지 검증합니다.
-   **버전 관리 포함:** 마이그레이션 파일도 소스 코드와 함께 Git과 같은 버전 관리 시스템에 포함하여 관리합니다.

데이터베이스 마이그레이션은 현대적인 애플리케이션 개발 및 배포 파이프라인에서 안정성과 효율성을 확보하기 위한 핵심적인 부분입니다. 