# Day 17 - 개념 1: 알림 시스템 설계 및 데이터베이스 스키마

알림 시스템은 사용자 경험을 향상시키고 서비스 참여를 유도하는 중요한 기능입니다. 효과적인 알림 시스템을 구축하기 위한 데이터베이스 스키마 설계 원칙과 고려사항에 대해 알아봅니다.

## 1. 알림 시스템의 주요 구성 요소

일반적인 웹/앱 알림 시스템은 다음과 같은 요소들을 포함합니다.

*   **알림 트리거 (Notification Triggers)**: 알림을 발생시키는 이벤트 또는 조건입니다. (예: 새 댓글 작성, 새 추천, 팔로우, 특정 시간 도달 등)
*   **알림 생성 로직 (Notification Generation Logic)**: 트리거 발생 시, 알림 내용, 수신자, 관련 정보 등을 포함하는 알림 데이터를 생성하는 로직입니다. (애플리케이션 서버, DB 트리거/함수, 백그라운드 잡 등에서 처리)
*   **알림 저장소 (Notification Storage)**: 생성된 알림 데이터를 저장하는 공간입니다. 일반적으로 관계형 데이터베이스(RDBMS)의 테이블을 사용합니다. (`notifications` 테이블)
*   **알림 전달 메커니즘 (Notification Delivery Mechanism)**: 저장된 알림을 사용자에게 전달하는 방법입니다. (웹 소켓, 푸시 알림, 이메일, 인앱 알림 등)
*   **알림 UI (Notification UI)**: 사용자가 알림 목록을 확인하고 상호작용(읽음 처리, 삭제, 링크 이동 등)할 수 있는 인터페이스입니다.

## 2. `notifications` 테이블 스키마 설계 원칙

알림 데이터를 저장할 `notifications` 테이블 설계 시 고려해야 할 주요 원칙은 다음과 같습니다.

*   **핵심 정보 포함**: 누가(수신자 `user_id`), 무엇을(알림 유형 `type`, 내용 `message`), 언제(`created_at`) 알림을 받았는지 명확히 식별할 수 있어야 합니다.
*   **확장성**: 다양한 종류의 알림(댓글, 추천, 공지 등)을 수용할 수 있도록 유연한 구조를 가져야 합니다. `type` 컬럼과 추가적인 메타데이터 컬럼(`resource_id`, `resource_type`, `actor_id` 등)이 이를 돕습니다.
*   **사용자 상호작용 지원**: 사용자가 알림을 읽었는지(`read` 플래그), 알림 클릭 시 어디로 이동해야 하는지(`link`) 등의 정보를 포함해야 합니다.
*   **성능 고려**:
    *   **인덱싱 (Indexing)**: 자주 조회되는 컬럼 조합(예: `user_id` + `created_at`, `user_id` + `read`)에 인덱스를 생성하여 조회 성능을 향상시킵니다.
    *   **데이터 보관 정책**: 오래된 알림 데이터는 성능 저하의 원인이 될 수 있으므로, 주기적으로 삭제하거나 아카이빙하는 정책을 고려할 수 있습니다.
*   **보안**: Row Level Security (RLS) 등을 사용하여 사용자가 자신의 알림 데이터에만 접근할 수 있도록 제한해야 합니다.

## 3. RLS (Row Level Security) 적용의 중요성

*   **개념**: 데이터베이스 테이블의 각 행(Row)에 대해 특정 사용자 또는 역할(Role)별로 접근 권한(SELECT, INSERT, UPDATE, DELETE)을 제어하는 보안 기능입니다.
*   **알림 시스템에서의 필요성**: `notifications` 테이블에는 여러 사용자의 알림 정보가 함께 저장됩니다. RLS 없이는 사용자가 다른 사람의 알림을 보거나 수정/삭제할 수 있는 심각한 보안 문제가 발생할 수 있습니다.
*   **Supabase에서의 RLS**: Supabase는 PostgreSQL 기반으로 강력한 RLS 기능을 제공합니다. `auth.uid()` 함수를 사용하여 현재 인증된 사용자의 ID를 가져와 테이블의 `user_id`와 비교하는 방식으로 정책을 쉽게 정의할 수 있습니다.
    ```sql
    -- 사용자가 자신의 알림만 조회할 수 있도록 하는 SELECT 정책 예시
    CREATE POLICY "Allow users to view their own notifications"
    ON public.notifications
    FOR SELECT
    USING (auth.uid() = user_id); -- 현재 사용자의 ID와 알림의 user_id가 같을 경우에만 조회 허용
    ```
*   **정책 설계 시 주의사항**: 각 작업(SELECT, UPDATE, DELETE, INSERT)에 대해 필요한 최소한의 권한만 부여하는 것이 좋습니다. 예를 들어, 사용자가 알림을 직접 생성(INSERT)할 필요가 없다면 INSERT 정책을 만들지 않거나 제한적으로 설정해야 합니다.

효과적인 스키마 설계와 적절한 RLS 정책 적용은 안전하고 효율적인 알림 시스템 구축의 기반이 됩니다. 