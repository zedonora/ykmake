# Day 15 - 개념 1: Supabase Storage와 파일 관리

## 1. Supabase Storage 소개

### Supabase Storage란?

Supabase Storage는 이미지, 비디오, PDF 등 다양한 종류의 파일을 저장하고 관리하기 위한 서비스입니다. 웹 및 모바일 애플리케이션에서 대용량 파일을 효율적으로 처리할 수 있도록 설계되었습니다. 내부적으로는 AWS S3, Google Cloud Storage와 같은 안정적인 클라우드 스토리지 인프라를 기반으로 작동할 수 있습니다.

### 왜 데이터베이스 대신 스토리지를 사용할까?

*   **확장성**: 데이터베이스는 텍스트 기반 데이터에 최적화되어 있지만, 대용량 바이너리 파일(이미지, 비디오 등) 저장에는 비효율적일 수 있습니다. 스토리지는 파일 크기와 개수에 맞춰 쉽게 확장됩니다.
*   **성능**: 스토리지는 파일 전송에 최적화되어 있으며, CDN(Content Delivery Network)과 연동하여 전 세계 사용자에게 파일을 빠르게 전송할 수 있습니다.
*   **비용 효율성**: 일반적으로 파일 저장 및 전송 비용은 데이터베이스 스토리지 및 연산 비용보다 저렴합니다.
*   **관리 편의성**: 파일 업로드, 다운로드, 접근 제어 등을 위한 전용 API와 관리 도구를 제공합니다.

## 2. 주요 개념

### 버킷 (Buckets)

*   파일을 저장하는 최상위 컨테이너입니다. 폴더나 디렉토리와 유사한 개념으로 파일을 그룹화합니다.
*   각 버킷은 고유한 이름을 가지며, 공개(Public) 또는 비공개(Private)로 설정할 수 있습니다.

### 객체 (Objects)

*   버킷 내에 저장되는 개별 파일입니다. 각 객체는 고유한 경로(Path)를 통해 식별됩니다.
*   객체에는 파일 데이터뿐만 아니라 메타데이터(예: MIME 타입, 크기, 사용자 정의 데이터)도 포함될 수 있습니다.

### 경로 (Paths) / 폴더 (Folders)

*   스토리지는 실제 폴더 구조를 가지지 않지만, 객체 경로에 슬래시(`/`)를 사용하여 폴더와 같은 계층 구조를 흉내 냅니다.
*   예: `avatars/user-123/profile.png`는 `avatars` 버킷 아래 `user-123` 폴더 안에 `profile.png` 파일이 있는 것처럼 보이게 합니다.
*   경로 기반으로 접근 제어 정책을 설정하는 것이 일반적입니다.

### 공개 버킷 vs. 비공개 버킷

*   **공개(Public) 버킷**: 버킷 내 파일에 대한 URL을 알면 누구나 (설정된 정책에 따라) 접근할 수 있습니다. 웹사이트 로고, 사용자 아바타 등 공개적으로 사용될 파일에 적합합니다. URL은 예측 가능하며 CDN 캐싱에 유리합니다.
*   **비공개(Private) 버킷**: 파일에 접근하려면 인증된 요청(예: Supabase 클라이언트 라이브러리를 통한 요청 또는 서명된 URL)이 필요합니다. 사용자 개인 파일, 구매 영수증 등 민감한 정보가 포함된 파일에 적합합니다.

### 스토리지 정책 (RLS for Storage)

*   데이터베이스의 RLS(Row Level Security)와 유사하게, 스토리지의 파일 접근 권한을 세밀하게 제어하는 규칙입니다.
*   버킷 또는 특정 경로의 파일에 대해 `SELECT`(다운로드), `INSERT`(업로드), `UPDATE`(수정), `DELETE`(삭제) 작업을 허용하거나 거부할 수 있습니다.
*   PostgreSQL의 정책 문법을 사용하여 정의하며, 사용자의 인증 상태 (`auth.uid()`, `auth.role()`), 파일 경로 (`storage.foldername()`, `name`), 파일 메타데이터 (`metadata`) 등을 조건으로 사용할 수 있습니다.

## 3. 정책 예시 및 사용 사례

### 공개 읽기, 인증된 사용자 쓰기 (아바타)

*   `SELECT`: 모든 사용자 (`anon`, `authenticated`) 허용 (`true`)
*   `INSERT`/`UPDATE`/`DELETE`: `authenticated` 사용자만 허용, 특정 경로(`auth.uid()`로 시작하는 경로)에만 적용

### 인증된 사용자만 읽기/쓰기 (사용자 개인 파일)

*   `SELECT`/`INSERT`/`UPDATE`/`DELETE`: `authenticated` 사용자만 허용, 특정 경로(`auth.uid()`로 시작하는 경로)에만 적용

### 역할 기반 접근 (관리자 전용 업로드)

*   `INSERT`: `authenticated` 사용자 중 특정 역할(예: `admin`)을 가진 사용자만 허용 (`check_role('admin')` 같은 함수 사용)

## 4. 애플리케이션과의 통합

*   일반적으로 Supabase 클라이언트 라이브러리 (`supabase.storage`)를 사용하여 파일 업로드, 다운로드, 목록 조회 등의 작업을 수행합니다.
*   파일을 업로드한 후, 해당 파일에 접근할 수 있는 공개 URL 또는 임시 URL을 받아 데이터베이스의 관련 레코드(예: `profiles` 테이블의 `avatar_url` 컬럼)에 저장하는 방식으로 연동합니다.

## 5. 베스트 프랙티스

*   **최소 권한 원칙**: 꼭 필요한 권한만 부여하는 구체적인 정책을 작성합니다.
*   **논리적 경로 구성**: 사용자 ID, 리소스 ID 등을 활용하여 파일을 체계적으로 정리합니다. (예: `avatars/user_id/`, `products/product_id/images/`)
*   **제한 설정**: 버킷 설정에서 허용할 MIME 타입과 최대 파일 크기를 지정하여 잘못된 파일 업로드를 방지합니다.
*   **오류 처리**: 파일 작업(업로드, 다운로드 등) 시 발생할 수 있는 오류(권한 없음, 파일 없음, 네트워크 문제 등)를 적절히 처리하는 로직을 구현합니다.
*   **보안**: 민감한 파일은 비공개 버킷을 사용하고, 필요시 서명된 URL(Signed URL)을 통해 제한된 시간 동안 접근을 허용하는 방식을 고려합니다. 