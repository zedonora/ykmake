# Day 16 - 개념 2: Remix Action을 이용한 데이터 변경 및 상태 관리\n\n추천(Upvote) 기능 구현은 사용자의 상호작용을 통해 서버의 데이터를 변경하는 대표적인 예시입니다. Remix에서는 이러한 데이터 변경 작업을 주로 `action` 함수를 통해 처리합니다.\n\n## 1. Remix Action의 역할\n\n*   **데이터 변경 처리**: `action` 함수는 클라이언트로부터 POST, PUT, PATCH, DELETE 등의 HTTP 메서드를 통해 전송된 요청을 받아 서버 측 로직을 실행하고 데이터를 변경하는 주된 통로입니다. (추천 기능에서는 POST 사용)\n*   **폼 제출 처리**: HTML `<form>` 제출 시 `method` 속성에 따라 해당 라우트의 `action` 함수가 호출됩니다. `action` 속성을 사용하여 다른 라우트의 `action`을 호출할 수도 있습니다 (예: `/api/upvote`).\n*   **서버 측 로직 수행**: `action` 함수 내에서는 다음과 같은 작업을 수행합니다.\n    *   요청 데이터 파싱 (`request.formData()`)\n    *   사용자 인증 및 권한 검사 (`createServerClient` 활용)\n    *   데이터 유효성 검사 (Zod 등 라이브러리 활용)\n    *   데이터베이스 작업 (Supabase 클라이언트 사용 - INSERT, DELETE 등)\n    *   외부 API 호출 등 기타 서버 로직\n*   **결과 반환**: `action` 함수는 처리 결과를 `json()` 유틸리티나 `redirect()` 등을 사용하여 클라이언트에 반환합니다. 이 결과는 UI 업데이트나 사용자 피드백에 사용됩니다.\n\n## 2. 데이터 변경 패턴: 추천/추천 취소 (토글)\n\n추천 기능은 사용자가 버튼을 클릭할 때마다 상태(추천함/추천 안 함)를 전환하는 토글(Toggle) 방식입니다. 이를 Action에서 구현하는 일반적인 패턴은 다음과 같습니다.\n\n1.  **현재 상태 확인**: 클라이언트에서 현재 사용자의 추천 상태(`currentlyUpvoted`)를 폼 데이터에 포함시켜 Action으로 전달합니다.\n2.  **상태에 따른 분기**: Action 함수 내에서 전달받은 `currentlyUpvoted` 값에 따라 다른 로직을 실행합니다.\n    *   `currentlyUpvoted`가 `true`이면 (이미 추천한 상태) -> 추천 취소 로직 (DELETE) 실행\n    *   `currentlyUpvoted`가 `false`이면 (추천 안 한 상태) -> 추천 로직 (INSERT) 실행\n3.  **데이터베이스 작업**: 해당 상태에 맞는 데이터베이스 쿼리(INSERT 또는 DELETE)를 실행합니다.\n4.  **결과 처리**: 작업 성공 또는 실패 결과를 반환합니다.\n\n## 3. 데이터베이스 상호작용 및 오류 처리\n\n### `INSERT` (추천)\n\n*   `supabase.from(\'upvotes\').insert({ user_id, resource_id })`를 사용하여 추천 기록을 삽입합니다.\n*   **Unique Constraint 오류 처리**: 사용자가 이미 추천한 항목을 다시 추천하려고 하면, 데이터베이스의 `unique_user_product_upvote` 또는 `unique_user_post_upvote` 제약 조건으로 인해 오류(PostgreSQL 오류 코드 `23505`)가 발생합니다.\n    *   이는 클라이언트의 상태(`currentlyUpvoted`)와 서버의 실제 상태가 불일치할 때 발생할 수 있습니다 (예: 다른 탭에서 추천 후 현재 탭에서 다시 추천).\n    *   이 오류는 심각한 시스템 오류라기보다는 예상 가능한 상태 불일치이므로, Action에서 `error.code === \'23505\'`를 확인하여 경고 로그를 남기거나, 클라이언트에 특정 상태 코드를 반환하는 등 부드럽게 처리할 수 있습니다. (예시 코드에서는 경고 출력 후 에러를 던지지 않음)\n\n### `DELETE` (추천 취소)\n\n*   `supabase.from(\'upvotes\').delete().match({ user_id, resource_id })`를 사용하여 추천 기록을 삭제합니다.\n*   **삭제 대상 없음**: 사용자가 추천하지 않은 항목에 대해 추천 취소를 시도하면, `match` 조건에 맞는 레코드가 없으므로 `delete` 작업은 아무런 효과 없이 성공적으로 완료될 수 있습니다 (오류 발생 안 함). 이는 일반적으로 문제가 되지 않습니다.\n\n### RLS(Row Level Security)\n\n*   `upvotes` 테이블에 설정된 RLS 정책은 `action` 함수 내에서 Supabase 클라이언트를 통해 실행되는 쿼리에도 적용됩니다.\n    *   `Allow authenticated insert access` 정책: `insert` 시 `user_id`가 현재 `auth.uid()`와 일치하는지 검사합니다.\n    *   `Allow own read and delete access` 정책: `delete` 시 `user_id`가 `auth.uid()`와 일치하는 레코드만 삭제 대상으로 간주합니다.\n*   이를 통해 악의적인 사용자가 다른 사용자의 이름으로 추천하거나 추천을 취소하는 것을 방지합니다.\n\n## 4. 상태 관리 및 UI 업데이트 (기본)\n\n*   **Action 실행 후**: Remix는 기본적으로 Action 실행 후 현재 페이지의 `loader` 함수를 다시 호출하여 최신 데이터를 가져오고 UI를 업데이트합니다.\n*   **한계**:\n    *   **전체 페이지 리로드**: 일반 `<Form>`을 사용하면 Action 처리 후 전체 페이지 데이터가 다시 로드되므로, 추천 버튼 하나를 클릭했을 뿐인데 페이지 전체가 깜빡이거나 다른 부분의 데이터까지 다시 로드되는 비효율이 발생할 수 있습니다.\n    *   **느린 피드백**: Action 실행 -> 데이터베이스 변경 -> `loader` 재실행 -> UI 업데이트 과정에 시간이 걸리므로, 사용자가 버튼을 클릭한 후 UI가 변경되기까지 지연이 발생합니다.\n*   **개선 방향 (다음 작업에서 다룰 내용)**:\n    *   **`useFetcher`**: 페이지 전체 리로드 없이 특정 Action만 호출하고 결과를 받아 부분적인 UI 업데이트를 수행할 수 있게 합니다.\n    *   **Optimistic UI**: 서버 응답을 기다리지 않고 사용자의 액션(클릭) 즉시 UI를 예상되는 결과 상태로 미리 업데이트하여 즉각적인 피드백을 제공합니다. 서버 응답 후 실제 상태와 다르면 UI를 다시 조정합니다.\n\n현재 단계(Task 2)에서는 Remix의 기본 동작 방식을 따르며, 다음 작업(Task 3, 4)에서 `useFetcher`와 Optimistic UI를 도입하여 사용자 경험을 개선할 것입니다.\n``` 