# 결제 요청 및 승인 로직 개념 설명

`jobs/day23/10.md`에서는 사용자가 Toss Payments 결제를 시도한 후, 그 결과를 처리하는 서버 측 로직(결제 승인 및 실패 처리)을 구현합니다.

## 1. 결제 승인 플로우 (Success Callback)

결제 위젯에서 사용자가 결제를 성공적으로 시작하면, 즉시 결제가 완료된 것이 아니라 **결제를 승인할 준비가 되었다**는 의미입니다. 최종적인 결제 완료 처리는 서버가 Toss Payments API를 통해 **명시적으로 승인**해야 합니다.

1.  **리디렉션**: 사용자는 결제 위젯에서 지정한 `successUrl`로 리디렉션됩니다. 이 URL에는 결제 정보(`paymentKey`, `orderId`, `amount`)가 쿼리 파라미터로 포함됩니다.
2.  **서버 수신 (`loader`)**: Remix 서버의 `payments.success.tsx` 라우트가 이 요청을 받습니다.
3.  **정보 추출**: `loader` 함수는 URL에서 `paymentKey`, `orderId`, `amount`를 추출합니다.
4.  **서버 측 검증 (매우 중요)**:
    *   **금액 검증**: 추출된 `amount`가 **절대로 클라이언트에서 온 값을 그대로 믿으면 안 됩니다.** 서버는 `orderId`를 사용하여 **데이터베이스에 저장된 원본 주문 정보**를 조회하고, 해당 주문의 **실제 결제 금액과 `amount`가 일치하는지 반드시 비교**해야 합니다. 금액이 다르면 결제를 거부해야 합니다. 이는 클라이언트 측에서의 금액 위변조 공격을 방지하는 핵심 보안 단계입니다.
    *   **주문 상태 확인**: 해당 주문이 이미 'PAID' 상태는 아닌지 확인합니다. 중복 승인을 방지하기 위함입니다. (멱등성 처리의 일부)
5.  **결제 승인 API 호출**: 검증이 통과되면, 서버는 추출한 `paymentKey`, `orderId`, 그리고 **검증된 `amount`** 를 사용하여 `app/lib/payments/toss.server.ts`의 `callTossPaymentsApi` 함수를 통해 Toss Payments의 `/v1/payments/confirm` API를 호출합니다. 이 호출에는 **시크릿 키**를 사용한 인증이 필요합니다.
6.  **API 응답 처리**: Toss Payments API는 승인 결과(성공 또는 실패)를 반환합니다.
7.  **후처리 (성공 시)**:
    *   **DB 업데이트**: 결제가 성공적으로 승인되면, 데이터베이스의 주문 상태를 'PAID'로 변경하고, `paymentKey`나 결제 시간 등의 관련 정보를 저장합니다.
    *   **사용자 알림**: 사용자에게 결제 성공 메시지를 보여줍니다. (예: 결제 완료 페이지 렌더링)
8.  **후처리 (실패 시)**:
    *   **오류 로깅**: API 승인 실패 시 오류 정보를 로그로 기록합니다.
    *   **사용자 알림**: 사용자에게 결제 실패 메시지를 보여주고, 실패 원인을 안내합니다. (예: 실패 페이지 렌더링 또는 리디렉션)

## 2. 결제 실패 처리 플로우 (Fail Callback)

사용자가 결제를 취소하거나, 카드 한도 초과, 시스템 오류 등 다양한 이유로 결제가 실패하면 `failUrl`로 리디렉션됩니다. 이 URL에는 실패 정보(`code`, `message`, `orderId`)가 쿼리 파라미터로 포함됩니다.

1.  **리디렉션**: 사용자는 `failUrl`로 리디렉션됩니다.
2.  **서버 수신 (`loader`)**: Remix 서버의 `payments.fail.tsx` 라우트가 요청을 받습니다.
3.  **정보 추출**: `loader` 함수는 URL에서 `code`, `message`, `orderId`를 추출합니다.
4.  **오류 로깅**: 서버는 수신된 실패 정보를 로그로 기록하여 추후 분석 및 디버깅에 활용합니다.
5.  **DB 업데이트 (선택 사항)**: 필요한 경우, 데이터베이스의 주문 상태를 'FAILED' 등으로 업데이트할 수 있습니다.
6.  **사용자 알림**: 사용자에게 결제 실패 메시지와 원인(`message`)을 보여주고, 필요한 경우 재시도 옵션 등을 제공합니다.

## 3. 보안 및 안정성 고려사항

- **서버 측 금액 검증**: 아무리 강조해도 지나치지 않습니다. 클라이언트가 전달한 금액은 절대 신뢰해서는 안 되며, 반드시 서버에 저장된 원본 주문 금액과 비교해야 합니다.
- **시크릿 키 보안**: 결제 승인 API 호출 시 사용되는 시크릿 키는 서버 측에서만 안전하게 관리되어야 합니다.
- **멱등성(Idempotency)**: 네트워크 오류 등으로 인해 동일한 결제 승인 요청이 여러 번 발생할 수 있습니다. Toss Payments API는 기본적으로 `paymentKey`를 통해 멱등성을 어느 정도 보장하지만, 우리 서버에서도 DB의 주문 상태를 확인하여 이미 처리된 결제가 중복으로 처리되지 않도록 방어하는 것이 좋습니다.
- **오류 처리 및 로깅**: 결제 승인 과정이나 실패 처리 과정에서 발생하는 모든 오류는 상세히 로그로 남겨 문제를 추적하고 해결할 수 있도록 해야 합니다.

이 단계까지 완료하면 기본적인 Toss Payments 연동 결제 흐름이 완성됩니다. 다음 단계는 이를 실제 아이디어 구매 등의 기능과 연결하는 작업입니다. 